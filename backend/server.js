// server.js (ESM)
// –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Ñ–∞–π–ª ‚Äî Express API + –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase admin + –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ middleware –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

// ===================== –ò–º–ø–æ—Ä—Ç—ã =====================
import express from 'express';      // Web-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è API
import cors from 'cors';            // CORS ‚Äî —á—Ç–æ–±—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–≥ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
import dotenv from 'dotenv';        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env
import path from 'path';            // –†–∞–±–æ—Ç–∞ —Å –ø—É—Ç—è–º–∏
import { fileURLToPath } from 'url';// –ü–æ–ª—É—á–µ–Ω–∏–µ __dirname –≤ ESM
import admin from 'firebase-admin'; // Firebase Admin SDK
import fs from 'fs';                // –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
import { registerSyncRoutes } from './routes/sync.js';
import { registerNotesRoutes } from './routes/notes.js'; 

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
dotenv.config();

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ===================== Firebase =====================
// –ü—Ä–æ–±—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Firebase Admin SDK, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–ª—é—á
let firestore = null;
try {
  const keyPath = path.join(__dirname, 'firebase-key.json');
  if (fs.existsSync(keyPath)) {
    const serviceAccount = JSON.parse(fs.readFileSync(keyPath, 'utf8'));
    admin.initializeApp({ credential: admin.credential.cert(serviceAccount) });
    firestore = admin.firestore();
    console.log('[Firebase] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ, Firestore –¥–æ—Å—Ç—É–ø–µ–Ω');
  } else {
    console.log('[Firebase] –§–∞–π–ª firebase-key.json –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ Firestore');
  }
} catch (err) {
  console.warn('[Firebase] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firestore. –†–∞–±–æ—Ç–∞–µ–º –±–µ–∑ –Ω–µ–≥–æ. –ü—Ä–∏—á–∏–Ω–∞:', err && err.message);
  firestore = null;
}

// ===================== Middleware =====================
// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º middleware –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ admin, —á—Ç–æ–±—ã verifyIdToken —Ä–∞–±–æ—Ç–∞–ª)
const { authMiddleware } = await import('./middleware/auth.js');

// ===================== –ê–¥–∞–ø—Ç–µ—Ä—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è =====================
// DualAdapter ‚Äî —É–º–µ–µ—Ç –ø–∏—Å–∞—Ç—å –∏ –≤ SQLite, –∏ –≤ —Ñ–∞–π–ª—ã
const DualAdapterModule = await import('./adapters/dualAdapter.js');
const adapter = DualAdapterModule;

// ===================== Express =====================
const app = express();
const PORT = process.env.PORT || 3001;
const STORAGE = (process.env.STORAGE || 'file').toLowerCase();

// –ü–æ–¥–∫–ª—é—á–∞–µ–º middleware
app.use(cors());
app.use(express.json());

// ===================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–∞–ø—Ç–µ—Ä–∞ =====================
try {
  await adapter.init(path.join(__dirname, 'data'));
  console.log('[Server] –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (SQLite + —Ñ–∞–π–ª—ã; Firestore —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω–∞)');
} catch (err) {
  console.error('[Server] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–¥–∞–ø—Ç–µ—Ä–∞:', err && err.message);
  process.exit(1);
}


// ===================== Middleware –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ =====================
// –ó–∞—â–∏—â–∞–µ–º –º–∞—Ä—à—Ä—É—Ç—ã /notes –∏ /sync
app.use('/notes', authMiddleware);
app.use('/sync', authMiddleware);

// // ===================== Notes API =====================


// --- Routes ---
app.use('/notes', registerNotesRoutes(DualAdapterModule));
app.use('/sync', registerSyncRoutes(DualAdapterModule));



// ===================== –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ =====================
app.listen(PORT, () => {
  console.log(`–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω: http://localhost:${PORT}  (—Ä–µ–∂–∏–º —Ö—Ä–∞–Ω–µ–Ω–∏—è STORAGE=${STORAGE})`);
  if (!firestore) console.log('[Server] Firestore –æ—Ç–∫–ª—é—á—ë–Ω ‚Äî –æ–±–ª–∞—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
});


// üîπ 2. –ú–µ—Ç–æ–¥—ã /sync

// –≠—Ç–∏ –º–µ—Ç–æ–¥—ã –Ω—É–∂–Ω—ã –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –æ—Ñ—Ñ–ª–∞–π–Ω–µ.

// –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?

// –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ /notes, —Ç–æ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–º–æ–∂–µ—Ç –Ω–∏—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.
// –ê /sync –ø–æ–∑–≤–æ–ª—è–µ—Ç:

// –†–∞–±–æ—Ç–∞—Ç—å –æ—Ñ—Ñ–ª–∞–π–Ω (—Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ SQLite/—Ñ–∞–π–ª—ã).

// –ü–æ—Ç–æ–º –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

// –ü–æ–ª—É—á–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª –∑–∞–º–µ—Ç–∫–∏ –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ).


// –ú–µ—Ç–æ–¥—ã:

// POST /sync/push
// –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å–≤–æ–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–æ–≤—ã–µ –∑–∞–º–µ—Ç–∫–∏, –ø—Ä–∞–≤–∫–∏, —É–¥–∞–ª–µ–Ω–∏–µ).
// –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:

// –∫–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∑–∞–º–µ—Ç–∫–∞ (uid),

// —á—Ç–æ –≤–µ—Ä—Å–∏—è —Å–≤–µ–∂–∞—è (updatedAt),

// –∏ –ª–∏–±–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç, –ª–∏–±–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç.

// ‚û°Ô∏è –ü—Ä–∏–º–µ—Ä:

// –¢—ã –±—ã–ª–∞ –æ—Ñ—Ñ–ª–∞–π–Ω, —Å–æ–∑–¥–∞–ª–∞ –∑–∞–º–µ—Ç–∫—É "–°–æ–≤–µ—â–∞–Ω–∏–µ".

// –ß–µ—Ä–µ–∑ —á–∞—Å –ø–æ—è–≤–∏–ª—Å—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.

// –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–µ–ª–∞–µ—Ç POST /sync/push ‚Üí —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏–Ω—è–ª –∑–∞–º–µ—Ç–∫—É ‚Üí —Ç–µ–ø–µ—Ä—å –æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.

// GET /sync/pull?lastSync=...
// –ö–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É —Å–µ—Ä–≤–µ—Ä–∞: "–ö–∞–∫–∏–µ –∑–∞–º–µ—Ç–∫–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ø–æ—Å–ª–µ –º–æ–µ–≥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–µ–∞–Ω—Å–∞?".
// –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏.

// ‚û°Ô∏è –ü—Ä–∏–º–µ—Ä:

// –¢—ã –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ —Å–æ–∑–¥–∞–ª–∞ –∑–∞–º–µ—Ç–∫—É "–î–æ–∫–ª–∞–¥".

// –ü–æ—Ç–æ–º –Ω–∞ –Ω–æ—É—Ç–±—É–∫–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –æ–Ω–æ –¥–µ–ª–∞–µ—Ç GET /sync/pull?lastSync=1696000000.

// –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—É—é –∑–∞–º–µ—Ç–∫—É "–î–æ–∫–ª–∞–¥".

// –¢–µ–ø–µ—Ä—å –Ω–∞ –Ω–æ—É—Ç–±—É–∫–µ —Å–ø–∏—Å–æ–∫ –∑–∞–º–µ—Ç–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω.